#include "FileWriter.h"
#include "LittleEndian.h"
#include "WONFile.h"

using namespace WONAPI;

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
FileWriter::FileWriter()
{
	mFile = NULL;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
FileWriter::~FileWriter()
{
	Close();
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
bool FileWriter::Open(const char *theFilePath, bool openIfReadOnly)
{
	Close();
	if(theFilePath[0]=='\0') // MS fopen.c asserts if theFilePath is empty
		return false;

	mFile = fopen(theFilePath,"wb");
	if(mFile==NULL && openIfReadOnly)
	{
		WONFile aFile(theFilePath);
		aFile.SetReadOnly(false);
		mFile = fopen(theFilePath,"wb");
	}
	return mFile!=NULL;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void FileWriter::Close()
{
	if(mFile!=NULL)
	{
		fclose(mFile);
		mFile = NULL;
	}
}


///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
unsigned long FileWriter::pos()
{
	if(mFile!=NULL)
		return ftell(mFile);
	else
		return 0;
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void FileWriter::SetPos(unsigned long thePos)
{
	if(mFile!=NULL)
	{
		if(fseek(mFile,thePos,SEEK_SET)!=0)
			throw FileReaderException("Attempt to setpos past end of file.");
	}
}


///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void FileWriter::WriteBytes(const void *theBuf, unsigned long theNumBytes)
{
	if(mFile==NULL)
		throw FileWriterException("NULL File.");

	if(fwrite(theBuf,1,theNumBytes,mFile)!=theNumBytes)
		throw FileWriterException("fwrite failed (disk full)");
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void FileWriter::WriteByte(unsigned char theByte)
{
	WriteBytes(&theByte,1);
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void FileWriter::WriteShort(unsigned short theShort)
{
	theShort = ShortToLittleEndian(theShort);
	WriteBytes(&theShort,2);
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void FileWriter::WriteLong(unsigned long theLong)
{
	theLong = LongToLittleEndian(theLong);
	WriteBytes(&theLong,4);
}
